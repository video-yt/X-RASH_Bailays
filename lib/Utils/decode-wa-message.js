Object.defineProperty(exports,"__esModule",{value:!0});exports.decryptMessageNode=exports.NACK_REASONS=exports.MISSING_KEYS_ERROR_TEXT=exports.NO_MESSAGE_FOUND_ERROR_TEXT=void 0;exports.decodeMessageNode=decodeMessageNode;const boom_1=require("@hapi/boom"),WAProto_1=require("../../WAProto"),WABinary_1=require("../WABinary"),generics_1=require("./generics");exports.NO_MESSAGE_FOUND_ERROR_TEXT="Message absent from node";exports.MISSING_KEYS_ERROR_TEXT="Key used already or never filled";
exports.NACK_REASONS={ParsingError:487,UnrecognizedStanza:488,UnrecognizedStanzaClass:489,UnrecognizedStanzaType:490,InvalidProtobuf:491,InvalidHostedCompanionStanza:493,MissingMessageSecret:495,SignalErrorOldCounter:496,MessageDeletedOnPeer:499,UnhandledError:500,UnsupportedAdminRevoke:550,UnsupportedLIDGroup:551,DBOperationFailed:552};
function decodeMessageNode(a,q,u){var e;let f,c;const n=a.attrs.id,b=a.attrs.from,g=a.attrs.participant;var d=a.attrs.recipient;var k=r=>(0,WABinary_1.areJidsSameUser)(r,q),h=r=>(0,WABinary_1.areJidsSameUser)(r,u);if((0,WABinary_1.isJidUser)(b)||(0,WABinary_1.isLidUser)(b)){if(d&&!(0,WABinary_1.isJidMetaIa)(d)){if(!(0,WABinary_1.areJidsSameUser)(b,q)&&!(0,WABinary_1.areJidsSameUser)(b,u))throw new boom_1.Boom("receipient present, but msg not from me",{data:a});f=d}else f=b;d="chat";c=b}else if((0,WABinary_1.isJidGroup)(b)){if(!g)throw new boom_1.Boom("No participant in group message");
d="group";c=g;f=b}else if((0,WABinary_1.isJidBroadcast)(b)){if(!g)throw new boom_1.Boom("No participant in group message");d=(0,WABinary_1.areJidsSameUser)(g,q);d=(0,WABinary_1.isJidStatusBroadcast)(b)?d?"direct_peer_status":"other_status":d?"peer_broadcast":"other_broadcast";f=b;c=g}else if((0,WABinary_1.isJidNewsletter)(b))d="newsletter",c=f=b;else throw new boom_1.Boom("Unknown message type",{data:a});h=((0,WABinary_1.isLidUser)(b)?h:k)(a.attrs.participant||a.attrs.from);k=null===(e=null===a||
void 0===a?void 0:a.attrs)||void 0===e?void 0:e.notify;e={remoteJid:f,fromMe:h,id:n,participant:g};a={key:e,messageTimestamp:+a.attrs.t,pushName:k,broadcast:(0,WABinary_1.isJidBroadcast)(b)};e.fromMe&&(a.status=WAProto_1.proto.WebMessageInfo.Status.SERVER_ACK);return{fullMessage:a,author:c,sender:"chat"===d?c:f}}
const decryptMessageNode=(a,q,u,e,f)=>{const {fullMessage:c,author:n,sender:b}=decodeMessageNode(a,q,u);return{fullMessage:c,category:a.attrs.category,author:n,async decrypt(){var g;let d=0;if(Array.isArray(a.content))for(const {tag:h,attrs:r,content:p}of a.content){if("verified_name"===h&&p instanceof Uint8Array){var k=WAProto_1.proto.VerifiedNameCertificate.decode(p);k=WAProto_1.proto.VerifiedNameCertificate.Details.decode(k.details);c.verifiedBizName=k.verifiedName}if("enc"!==h&&"plaintext"!==
h)continue;if(!(p instanceof Uint8Array))continue;d+=1;let t;try{const l="plaintext"===h?"plaintext":r.type;switch(l){case "skmsg":t=await e.decryptGroupMessage({group:b,authorJid:n,msg:p});break;case "pkmsg":case "msg":const v=(0,WABinary_1.isJidUser)(b)?b:n;t=await e.decryptMessage({jid:v,type:l,ciphertext:p});break;case "plaintext":t=p;break;default:throw Error(`Unknown e2e type: ${l}`);}let m=WAProto_1.proto.Message.decode("plaintext"!==l?(0,generics_1.unpadRandomMax16)(t):t);m=(null===(g=m.deviceSentMessage)||
void 0===g?void 0:g.message)||m;if(m.senderKeyDistributionMessage)try{await e.processSenderKeyDistributionMessage({authorJid:n,item:m.senderKeyDistributionMessage})}catch(v){f.error({key:c.key,err:v},"failed to decrypt message")}c.message?Object.assign(c.message,m):c.message=m}catch(l){f.error({key:c.key,err:l},"failed to decrypt message"),c.messageStubType=WAProto_1.proto.WebMessageInfo.StubType.CIPHERTEXT,c.messageStubParameters=[l.message]}}d||(c.messageStubType=WAProto_1.proto.WebMessageInfo.StubType.CIPHERTEXT,
c.messageStubParameters=[exports.NO_MESSAGE_FOUND_ERROR_TEXT])}}};exports.decryptMessageNode=decryptMessageNode;
